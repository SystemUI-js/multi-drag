name: Publish to npm (version branches)

on:
  push:
    branches:
      - 'version/*'

permissions:
  contents: read

jobs:
  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      # 拉取代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 解析分支类型并设定 npm dist-tag
      - name: Classify branch and prepare env
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Detected branch: $BRANCH"

          # 从分支名称提取版本号：version/1.0.0 -> 1.0.0
          VERSION="${BRANCH#version/}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

          # 根据 package.json 的 version 判断是否为预发布版本
          PKG_VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).version)")

          if [[ "$PKG_VERSION" =~ -dev ]]; then
            echo "PUBLISH_TAG=dev" >> "$GITHUB_ENV"
            echo "Version type: Dev Pre-release"
          elif [[ "$PKG_VERSION" =~ -beta ]]; then
            echo "PUBLISH_TAG=beta" >> "$GITHUB_ENV"
            echo "Version type: Beta Pre-release"
          else
            echo "PUBLISH_TAG=latest" >> "$GITHUB_ENV"
            echo "Version type: Release"
          fi

          echo "Branch version: $VERSION"
          echo "Package version: $PKG_VERSION"
          echo "Publish tag: $PUBLISH_TAG"

      # 安装 Node，并配置 npm registry（用于 npm publish 鉴权）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: yarn

      # 使用 Yarn 安装依赖（项目包含 yarn.lock）
      - name: Install dependencies
        run: |
          corepack enable
          yarn --version
          yarn install --frozen-lockfile

      # 读取 package.json 的 name 与 version，并检查该版本是否已发布
      # 已发布则跳过后续发布步骤，避免重复发布导致失败
      - name: Check if version already published
        id: version
        shell: bash
        run: |
          PKG_NAME=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).name)")
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).version)")
          echo "Package: $PKG_NAME"
          echo "Version: $VERSION"
          if npm view "$PKG_NAME@$VERSION" version > /dev/null 2>&1; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "Version $VERSION already exists on npm, skip publishing."
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "Version $VERSION not found on npm, will publish."
          fi

      # 构建项目（npm publish 会触发 prepublishOnly，其中也会执行构建，但这里提前构建以暴露错误）
      - name: Build project
        if: steps.version.outputs.should_publish == 'true'
        run: |
          yarn build:all

      # 发布到 npm。latest/dev/beta 分别使用对应的 dist-tag
      # 需要在项目 Secrets 配置 NPM_TOKEN（具有发布权限的 npm 令牌）
      - name: Publish to npm
        if: steps.version.outputs.should_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # 使用 npm publish 以触发 prepublishOnly（包含构建），并指定 tag 与访问级别
          npm publish --tag "$PUBLISH_TAG" --access public

      # 确保预发布标签的 dist-tag 指向当前 version（支持 dev 和 beta）
      - name: Ensure pre-release dist-tag
        if: (env.PUBLISH_TAG == 'dev' || env.PUBLISH_TAG == 'beta') && steps.version.outputs.should_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_NAME=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).name)")
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).version)")
          echo "Ensure dist-tag: ${PUBLISH_TAG} -> $VERSION"
          # 若版本已存在，也可重复设置 tag；若已指向则不变
          npm dist-tag add "$PKG_NAME@$VERSION" "$PUBLISH_TAG" || true
          npm dist-tag ls "$PKG_NAME"
